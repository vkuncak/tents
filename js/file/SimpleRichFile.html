<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rich Text Editor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controls { margin-bottom: 10px; }
    #editor { 
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 300px;
      margin-top: 10px;
      outline: none;
      overflow: auto;
    }
    #filename { width: 200px; }
    button { margin-right: 5px; }
    input[type="file"] { display: none; }
  </style>
  <!-- DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js" integrity="sha384-XFqoSYo8dO0w64+6D0yMqdiDZZu7AgWQ9iQ+zFG+G6lglp8E5ktqg5nV+6R8lZlp" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Simple Rich Text Editor</h1>
  <div id="controls">
    <button id="openBtn">Open</button>
    <button id="boldBtn"><b>B</b></button>
    <label for="filename">Filename:</label>
    <input type="text" id="filename" value="untitled.html" />
    <button id="saveBtn">Save</button>
    <span id="status" style="margin-left:10px;color:green;"></span>
    <input type="file" id="fileInput" accept=".html,.htm" />
  </div>
  <div id="editor" contenteditable="true" placeholder="Type your rich text here..."></div>

  <script>
    const filenameInput = document.getElementById('filename');
    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    const boldBtn = document.getElementById('boldBtn');
    const openBtn = document.getElementById('openBtn');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    let fileHandle;
    let lastSavedContent = '';
    let lastSavedFilename = '';

    // Reset handle when filename manually edited
    filenameInput.addEventListener('input', () => {
      fileHandle = null;
      lastSavedFilename = '';
    });

    // Bold formatting
    boldBtn.addEventListener('click', () => {
      document.execCommand('bold', false, null);
      editor.focus();
    });

    // Open existing file without replacing it
    openBtn.addEventListener('click', async () => {
      if (window.showOpenFilePicker) {
        try {
          const [handle] = await window.showOpenFilePicker({
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }],
            multiple: false
          });
          fileHandle = handle;
          const file = await handle.getFile();
          const raw = await file.text();
          const content = DOMPurify.sanitize(raw);
          editor.innerHTML = content;
          filenameInput.value = handle.name;
          lastSavedContent = content;
          lastSavedFilename = handle.name;
        } catch (err) {
          console.error('Open failed:', err);
        }
      } else {
        fileInput.click();
      }
    });

    // Fallback file input for open
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const raw = reader.result;
        const content = DOMPurify.sanitize(raw);
        editor.innerHTML = content;
        filenameInput.value = file.name;
        lastSavedContent = content;
        lastSavedFilename = file.name;
        fileHandle = null;
      };
      reader.readAsText(file);
      fileInput.value = '';
    });

    // Save logic (reuses handle to avoid extra dialog after open)
    async function saveToFile() {
      const content = editor.innerHTML;
      let suggestedName = filenameInput.value.trim() || 'untitled.html';

      // Skip if unchanged
      if (content === lastSavedContent && suggestedName === lastSavedFilename) return;

      try {
        if (fileHandle) {
          const writable = await fileHandle.createWritable();
          await writable.write(new Blob([content], { type: 'text/html' }));
          await writable.close();
        } else if (window.showSaveFilePicker) {
          const options = {
            suggestedName,
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }],
          };
          fileHandle = await window.showSaveFilePicker(options);
          filenameInput.value = fileHandle.name;
          const writable = await fileHandle.createWritable();
          await writable.write(new Blob([content], { type: 'text/html' }));
          await writable.close();
        } else {
          const blob = new Blob([content], { type: 'text/html' });
          const link = document.createElement('a');
          link.download = suggestedName;
          link.href = URL.createObjectURL(blob);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        }
        lastSavedContent = content;
        lastSavedFilename = filenameInput.value;
        showStatus('Saved at ' + new Date().toLocaleTimeString());
      } catch (err) {
        console.error('Save failed:', err);
        showStatus('Save failed', true);
      }
    }

    function showStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.style.color = isError ? 'red' : 'green';
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }

    saveBtn.addEventListener('click', saveToFile);
    // Autosave disabled
  </script>
</body>
</html>
